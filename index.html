<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin">
    <link rel="stylesheet" type="text/css" href="govhack.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <meta charset="utf-8">
    <title>Inefficient Directions</title>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
    <script>
    
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;
var searched=0;
var waypts = [];
var way = [];
var geocoder = new google.maps.Geocoder();
var bannedI = [];
var usedI = [];

function initialize() {
  directionsDisplay = new google.maps.DirectionsRenderer();
  var canberra = new google.maps.LatLng(-35.2819998,149.1286843);
  var mapOptions = {
    zoom: 14,
    center: canberra,
    disableDefaultUI: true,
  }

  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  directionsDisplay.setMap(map);

  var defaultBounds = new google.maps.LatLngBounds(
  new google.maps.LatLng(-35.1719998,149.1186843),
  new google.maps.LatLng(-35.2819998,149.1386843)
      );

  var options = {
           componentRestrictions: {country: "au"}
  };

  var input = document.getElementById('start');
        var autocomplete = new google.maps.places.Autocomplete(input,options);
          autocomplete.bindTo('bounds', map);

  var input = document.getElementById('end');
        var autocomplete = new google.maps.places.Autocomplete(input,options);
          autocomplete.bindTo('bounds', map);


  $.getJSON( "art.json", function( data ) {
      for (var i =0;i<data.data.length;i++){
      waypts.push({ location:new google.maps.LatLng( data.data[i][18][1] ,  data.data[i][18][2]), stopover:true});
      way.push({
        named:data.data[i][8],
        desc:data.data[i][15],
        url:data.data[i][16][0],
        img:data.data[i][17][0],
        });
      }
      });

}

function totalAir ( tmplist ) {
  var total = 0;
  for(var k=0;k<tmplist.length-1;k++){
    total+=distl( tmplist[k], tmplist[k+1] );
  }
  return total;
}

//Adds the node that will minimize additional distance
function add_min(ll1, ll2) {
  var ret = 1;
  var min = 10000;
  var ll3, dist;
  for (var i =0;i<waypts.length;i++){
    if( $.inArray(i, bannedI)>-1 || $.inArray(i, usedI)>-1 ) {
      continue;
    } else {
    ll3 = waypts[i].location;
    dist = distl(ll1, ll3) + distl(ll3, ll2);
    if(dist<min){
      ret=i;
      min=dist;
    }
    }
  }
  var add = min - distl( ll1, ll2)
  usedI.push(ret);
  return [ret,add];
}

function add_best_min( tmplist ) {

          var minAll = [0,1,10000];
          for(var ind=1;ind<tmplist.length;ind++){
          var newNod= add_min(tmplist[ind-1], tmplist[ind]);
          if(newNod[1]<minAll[2]){
            minAll=[newNod[0],ind,newNod[1]];
          }
          }

  return minAll;

}

function distl(ll1, ll2){
  var ret = Math.pow(ll2.lat()-ll1.lat(), 2) + Math.pow(ll2.lng()-ll1.lng(), 2);
    return Math.abs(ret);
}

function getRandom(min, max) {
      return min + Math.floor(Math.random() * (max - min + 1));
}



function calcRoute() {
if (searched){
  document.getElementById('search').style.backgroundImage="url('glass.png')";
searched=0;
      var summaryPanel = document.getElementById('directions_panel');
      summaryPanel.innerHTML = '';
document.getElementById('start').disabled = false;
document.getElementById('end').disabled = false;
return;
}
searched=1;
var finwaypts = [];
var finway = [];
usedI = [];
document.getElementById('start').disabled = true;
document.getElementById('end').disabled = true;
  document.getElementById('search').style.backgroundImage="url('close.png')";
  var start = document.getElementById('start').value;
  var end = document.getElementById('end').value;

  
    // So much nesting! I should use calbacks instead.
    geocoder.geocode( { 'address': start}, function(results, status) {
    var ll1 = results[0].geometry.location;
    geocoder.geocode( { 'address': end}, function(results, status) {
          var ll2 = results[0].geometry.location;
          var ll3 = waypts[10].location;
          var tmplist = [ll1, ll2];
          for(var j=0;j<3;j++){
          var indeces=add_best_min(tmplist);
          ind=indeces[1];
          newNode=indeces[0];
          finwaypts.splice(ind-1, 0, waypts[newNode]);
          finway.splice(ind-1, 0, way[newNode]);
          tmplist.splice(ind-1, 0, waypts[newNode].location);
          }

  var request = {
      origin: start,
      destination: end,
      waypoints: finwaypts,
      optimizeWaypoints: true,
      travelMode: google.maps.TravelMode.WALKING,
  };

  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {


      directionsDisplay.setDirections(response);
      var route = response.routes[0];
      var summaryPanel = document.getElementById('directions_panel');
      var total=0;
      summaryPanel.innerHTML = '';
      // For each route, display summary information.
      for (var i = 0; i < route.legs.length-1; i++) {
        var seg = route.waypoint_order[i];
        total += route.legs[seg].distance.value;
        $('#directions_panel').append( '<div class="boxn"><div class="thumbnail"><img src="'+finway[seg].img+'" class="thumb"/></div><div class="contnail"><b>' + finway[seg].named + '</b><br>' + finway[seg].desc.substring(0,100) + '...<br /></div><div class="travnail">+' + route.legs[seg].distance.text + '</div></div>').hide().show('slow');
      }
      //alert(total);

    }
    else{
    alert('Directions unavailable for the following reason: ' + status);
    }

  });

      });
      });

}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas" style=""></div>
    <div id="control_panel">
      <div id='noscroll'>
    <input type='text' value="***REMOVED*** Shops, ACT" id='start' class='inputBox' >
    <div id="directions_panel" style=""></div>
    <input type='text' value='Dickson College, ACT, 2602' id='end' class='inputBox' >
    <input type="submit" onclick="calcRoute();" class='inputButton' value='' id='search'>
    </div>

  </div>

  </body>
</html>
